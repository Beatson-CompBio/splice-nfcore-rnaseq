/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Modular Stage Configuration for Custom RNA-seq Pipeline
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Allows running individual stages of the pipeline:
    1. Preprocessing only
    2. Quantification only  
    3. Post-processing only
    4. Any combination
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

params {
    // Job organization parameters
    job_id = null
    short_job_id = null
    
    // Base paths (relative to output_data execution directory)
    input_base_path = '../input_data'
    data_path = "${params.input_base_path}/data"
    container_cache_path = "${params.input_base_path}/containers"
    
    // Default: run all stages
    run_preprocessing = true
    run_quantification = true  
    run_postprocessing = true
    
    // Stage-specific entry points and skip parameters will be set in profiles below
}

// Configure container caching
singularity {
    enabled = true
    cacheDir = params.container_cache_path
    autoMounts = true
}

// Base process configuration
process {
    // Organize outputs by job_id if provided
    publishDir = [
        [
            path: { params.job_id ? "${params.outdir}/${params.job_id}" : "${params.outdir}" },
            mode: params.publish_dir_mode ?: 'copy',
            saveAs: { filename -> filename }
        ]
    ]
}

profiles {
    
    /*
    ================================================================================
                                PREPROCESSING ONLY
    ================================================================================
    Run only: FastQC → FastP → Strandedness inference → FastQC (post-trim)
    
    Input required: 
    - Raw FASTQ files in ../input_data/data/
    - Samplesheet with sample,fastq_1,fastq_2,strandedness columns
    
    Output:
    - Trimmed FASTQ files
    - FastQC reports (raw and trimmed)
    - Strandedness inference results
    - MultiQC report for preprocessing
    */
    preprocessing_only {
        params {
            // Enable only preprocessing
            run_preprocessing = true
            run_quantification = false
            run_postprocessing = false
            
            // Skip everything after preprocessing
            skip_alignment = true
            skip_pseudo_alignment = true
            skip_markduplicates = true
            skip_bigwig = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            // Keep essential QC
            skip_fastqc = false
            skip_multiqc = false
            
            // Input configuration
            input = "${params.data_path}/samplesheet.csv"
            outdir = "./preprocessing_results"
        }
    }
    
    /*
    ================================================================================
                                QUANTIFICATION ONLY  
    ================================================================================
    Run only: STAR alignment → Salmon quantification (gene + transcript level)
    
    Input required:
    - Trimmed FASTQ files from preprocessing stage
    - Reference genome FASTA and GTF
    - OR pre-built STAR and Salmon indices
    
    Output:
    - BAM files (genome and transcriptome)
    - Gene and transcript count matrices
    - STAR alignment logs
    - Salmon quantification results
    */
    quantification_only {
        params {
            // Enable only quantification
            run_preprocessing = false
            run_quantification = true
            run_postprocessing = false
            
            // Skip preprocessing (assume trimmed FASTQs provided)
            skip_fastqc = true
            skip_trimming = true
            
            // Skip post-processing
            skip_markduplicates = true
            skip_bigwig = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            // Keep alignment and quantification
            skip_alignment = false
            skip_pseudo_alignment = true  // We want STAR-Salmon, not pseudo-alignment
            
            // Minimal QC for quantification
            skip_multiqc = false
            
            // Input configuration (trimmed FASTQs)
            input = "${params.data_path}/trimmed_samplesheet.csv"
            outdir = "./quantification_results"
        }
    }
    
    /*
    ================================================================================
                              POST-PROCESSING ONLY
    ================================================================================
    Run only: SAMtools → Picard MarkDuplicates → BEDtools → BigWig → MultiQC
    
    Input required:
    - BAM files from quantification stage
    - Reference genome FASTA
    - Chromosome sizes file
    
    Output:
    - Processed BAM files (sorted, indexed, deduplicated)
    - BigWig coverage files
    - Comprehensive QC report
    */
    postprocessing_only {
        params {
            // Enable only post-processing
            run_preprocessing = false
            run_quantification = false
            run_postprocessing = true
            
            // Skip early stages (assume BAMs provided)
            skip_fastqc = true
            skip_trimming = true
            skip_alignment = true
            skip_pseudo_alignment = true
            
            // Enable post-alignment processing
            skip_markduplicates = false
            skip_bigwig = false
            skip_multiqc = false
            
            // Skip optional analyses
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            // Input configuration (BAM files)
            input = "${params.data_path}/bam_samplesheet.csv"
            outdir = "./postprocessing_results"
        }
    }
    
    /*
    ================================================================================
                            PREPROCESSING + QUANTIFICATION
    ================================================================================
    Run: FastQC → FastP → STAR-Salmon → Gene/Transcript counts
    Skip: Post-processing (BAM cleanup, BigWig, etc.)
    */
    preprocess_quantify {
        params {
            run_preprocessing = true
            run_quantification = true
            run_postprocessing = false
            
            // Skip post-processing only
            skip_markduplicates = true
            skip_bigwig = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            input = "${params.data_path}/samplesheet.csv"
            outdir = "./preprocess_quantify_results"
        }
    }
    
    /*
    ================================================================================
                            QUANTIFICATION + POST-PROCESSING
    ================================================================================
    Run: STAR-Salmon → SAMtools → Picard → BEDtools → BigWig
    Skip: Preprocessing (assume trimmed FASTQs provided)
    */
    quantify_postprocess {
        params {
            run_preprocessing = false
            run_quantification = true
            run_postprocessing = true
            
            // Skip preprocessing only
            skip_fastqc = true
            skip_trimming = true
            
            // Enable quantification and post-processing
            skip_alignment = false
            skip_markduplicates = false
            skip_bigwig = false
            
            // Skip optional analyses
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            input = "${params.data_path}/trimmed_samplesheet.csv"
            outdir = "./quantify_postprocess_results"
        }
    }
    
    /*
    ================================================================================
                                FULL PIPELINE  
    ================================================================================
    Run all stages: Preprocessing → Quantification → Post-processing
    This is the default streamlined configuration
    */
    full_pipeline {
        params {
            run_preprocessing = true
            run_quantification = true
            run_postprocessing = true
            
            // Skip only unwanted analyses (from your original streamlined config)
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
            
            // Keep essential processes
            skip_fastqc = false
            skip_alignment = false
            skip_markduplicates = false
            skip_bigwig = false
            skip_multiqc = false
            
            input = "${params.data_path}/samplesheet.csv"
            outdir = "./full_pipeline_results"
        }
    }
}

// Job-specific output organization
if (params.job_id) {
    process {
        publishDir = [
            [
                path: { "${params.outdir}/${params.job_id}/${task.process.tokenize(':')[-1].toLowerCase()}" },
                mode: params.publish_dir_mode ?: 'copy',
                pattern: '*'
            ]
        ]
    }
}

// Container optimization for your setup
if (params.container_cache_path && file(params.container_cache_path).exists()) {
    singularity {
        enabled = true
        cacheDir = params.container_cache_path
        autoMounts = true
        runOptions = '--cleanenv'
    }
    
    process {
        beforeScript = """
        export SINGULARITY_CACHEDIR=${params.container_cache_path}
        export SINGULARITY_TMPDIR=\$PWD/tmp
        mkdir -p \$SINGULARITY_TMPDIR
        """
    }
}