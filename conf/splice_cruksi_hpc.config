/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    SPLICE CRUK-SI HPC Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Custom configuration for your specific HPC environment and directory structure
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Include the modular stages configuration
includeConfig 'modular_stages.config'

params {
    // HPC-specific settings
    config_profile_name        = 'SPLICE CRUK-SI HPC'
    config_profile_description = 'Custom configuration for SPLICE CRUK-SI HPC environment'
    config_profile_contact     = 'your.email@cruk.org'
    
    // Default resource settings
    max_memory                 = '256.GB'
    max_cpus                   = 32
    max_time                   = '48.h'
    
    // Container settings optimized for your setup
    singularity_pull_docker_container = false
    
    // Directory structure (relative to execution from output_data/)
    input_base_path = '../input_data'
    data_path = "${params.input_base_path}/data"
    container_cache_path = "${params.input_base_path}/containers"
    
    // GDC STAR parameters (from your previous work)
    extra_star_align_args = [
        '--outFilterMismatchNoverLmax 0.1',
        '--outFilterScoreMinOverLread 0.33',
        '--outFilterMatchNminOverLread 0.33',
        '--limitSjdbInsertNsj 1200000',
        '--outFilterIntronMotifs None',
        '--alignSoftClipAtReferenceEnds Yes',
        '--quantMode TranscriptomeSAM GeneCounts',
        '--outSAMunmapped Within',
        '--genomeLoad NoSharedMemory',
        '--chimSegmentMin 15',
        '--chimJunctionOverhangMin 15',
        '--chimOutType Junctions SeparateSAMold WithinBAM SoftClip',
        '--chimOutJunctionFormat 1',
        '--chimMainSegmentMultNmax 1',
        '--outSAMattributes NH HI AS nM NM ch'
    ].join(' ')
}

// Singularity configuration for your HPC
singularity {
    enabled = true
    autoMounts = true
    cacheDir = params.container_cache_path
    runOptions = '--cleanenv --containall'
}

// Disable other container engines
docker.enabled = false
conda.enabled = false

process {
    // Default executor for HPC
    executor = 'local'  // Change to 'slurm', 'pbs', 'sge' etc. as appropriate
    
    // Default resources (will be overridden by process-specific settings)
    cpus   = { 2 * task.attempt }
    memory = { 8.GB * task.attempt }
    time   = { 4.h * task.attempt }
    
    // Error handling
    errorStrategy = { task.exitStatus in ((130..145) + 104 + 175) ? 'retry' : 'finish' }
    maxRetries = 2
    maxErrors = '-1'
    
    // Process-specific resource allocation for GDC STAR
    withName:'.*STAR.*' {
        cpus   = { 16 * task.attempt }
        memory = { 64.GB * task.attempt }
        time   = { 24.h * task.attempt }
    }
    
    withName:'.*SALMON.*' {
        cpus   = { 8 * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 8.h * task.attempt }
    }
    
    withName:'.*FASTP.*' {
        cpus   = { 4 * task.attempt }
        memory = { 8.GB * task.attempt }
        time   = { 4.h * task.attempt }
    }
    
    withName:'.*FASTQC.*' {
        cpus   = { 2 * task.attempt }
        memory = { 4.GB * task.attempt }
        time   = { 2.h * task.attempt }
    }
    
    withName:'.*SAMTOOLS.*' {
        cpus   = { 4 * task.attempt }
        memory = { 8.GB * task.attempt }
        time   = { 4.h * task.attempt }
    }
    
    withName:'.*PICARD.*' {
        cpus   = { 2 * task.attempt }
        memory = { 16.GB * task.attempt }
        time   = { 8.h * task.attempt }
    }
    
    withName:'.*BEDTOOLS.*' {
        cpus   = { 4 * task.attempt }
        memory = { 8.GB * task.attempt }
        time   = { 4.h * task.attempt }
    }
    
    withName:'.*MULTIQC.*' {
        cpus   = { 1 }
        memory = { 4.GB * task.attempt }
        time   = { 2.h * task.attempt }
    }
    
    // Job-specific output organization with job_id
    publishDir = { 
        def base_dir = params.job_id ? "${params.outdir}/${params.job_id}" : params.outdir
        def process_dir = task.process.tokenize(':')[-1].toLowerCase()
        [
            path: "${base_dir}/${process_dir}",
            mode: params.publish_dir_mode ?: 'copy',
            pattern: '*',
            saveAs: { filename ->
                // Organize by short_job_id if provided
                if (params.short_job_id && filename) {
                    return "${params.short_job_id}_${filename}"
                }
                return filename
            }
        ]
    }
    
    // Environment setup for containers
    beforeScript = """
    export SINGULARITY_CACHEDIR=${params.container_cache_path}
    export SINGULARITY_TMPDIR=\$PWD/singularity_tmp
    mkdir -p \$SINGULARITY_TMPDIR
    
    # Log job information
    echo "Job ID: ${params.job_id ?: 'not_specified'}"
    echo "Short Job ID: ${params.short_job_id ?: 'not_specified'}"
    echo "Container cache: ${params.container_cache_path}"
    echo "Data path: ${params.data_path}"
    echo "Working directory: \$PWD"
    """
}

// Custom profiles that inherit from this HPC config
profiles {
    
    // HPC + Preprocessing only
    hpc_preprocessing {
        includeConfig 'splice_cruksi_hpc.config'
        params {
            // Inherit HPC settings, add preprocessing-only
            run_preprocessing = true
            run_quantification = false
            run_postprocessing = false
            
            skip_alignment = true
            skip_pseudo_alignment = true
            skip_markduplicates = true
            skip_bigwig = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
        }
    }
    
    // HPC + Quantification only
    hpc_quantification {
        includeConfig 'splice_cruksi_hpc.config'
        params {
            run_preprocessing = false
            run_quantification = true
            run_postprocessing = false
            
            skip_fastqc = true
            skip_trimming = true
            skip_markduplicates = true
            skip_bigwig = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
        }
    }
    
    // HPC + Post-processing only
    hpc_postprocessing {
        includeConfig 'splice_cruksi_hpc.config'
        params {
            run_preprocessing = false
            run_quantification = false
            run_postprocessing = true
            
            skip_fastqc = true
            skip_trimming = true
            skip_alignment = true
            skip_pseudo_alignment = true
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
        }
    }
    
    // HPC + Full pipeline (your streamlined config)
    hpc_full {
        includeConfig 'splice_cruksi_hpc.config'
        params {
            run_preprocessing = true
            run_quantification = true
            run_postprocessing = true
            
            // Skip only unwanted analyses
            skip_stringtie = true
            skip_deseq2_qc = true
            skip_preseq = true
            skip_dupradar = true
            skip_qualimap = true
            skip_rseqc = true
            skip_biotype_qc = true
        }
    }
}